<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Roofy</title>
    
    <!-- styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
    <link rel="stylesheet" href="/styles/styles.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

  </head>
  <body>
    <%- include('include/navbar'); %>
    
    <div class="container" style="margin-top: 40px; margin-bottom: 40px;">
            
      <%
        let listing = data.data[0];
      %>
      <img src="/images/listings/<%= listing.image ? listing.image : 'default.png'; %>" width="25%">
      <img src="/images/listings/<%= listing.image ? listing.image : 'default.png'; %>" width="25%">
      <img src="/images/listings/<%= listing.image ? listing.image : 'default.png'; %>" width="25%">
      <img src="/images/listings/<%= listing.image ? listing.image : 'default.png'; %>" width="25%">
      <h1><%= listing.title %> for <%= listing.sale_or_rent %></h1>
      <h3><%= listing.rooms == "Studio" ? "Studio Apartment" : listing.rooms %>, <%= listing.property_type %></h3>
        <div class="row row-cols-1 row-cols-md-2 g-4">
          <div class="col">
            <div class="card h-100">
              <div class="card-body">
                <div class="row">
                  <div class="col-8 col-sm-6">
                    <p><b>Listing ID</b><br/> 
                    <i class="bi-card-list"></i> <%= listing.listing_id %><br/>                       
                    <b>Posted by</b><br/> 
                    <i class="bi-file-person"></i> <%= listing.seller_id %><br/> 
                    <b>Posted on</b><br/> 
                    <i class="bi-clock"></i> <%= listing.listing_datetime ? listing.listing_datetime.toISOString().slice(0, 10) : ''; %></p> 
                  </div>
                  <div class="col-8 col-sm-6">
                    <b>Status</b><br/>
                    <%= listing.status %><br/>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card h-100">
              <div class="card-body">
                <style>
                  .chip {display: inline-block; padding: 0 25px; height: 50px; font-size: 16px; line-height: 50px; border-radius: 25px; background-color:rgb(250, 192, 170);}
                  .chip img { float: left; margin: 0 10px 0 -25px; height: 50px; width: 50px; border-radius: 50%; color: orange;}
                </style>
                <div class="chip">
                  <img src="/images/LinkZelda.png" alt="Avatar" width="96" height="96">
                  <%= listing.name %>
                </div><br/> 
                <i class="bi-telephone"></i> +65<%= listing.contact_number %>
                <div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
                  Ratings
                  <style> .checked {color: rgb(252, 235, 7);}
                  </style>            
                  <span class="fa fa-star checked"></span>
                  <span class="fa fa-star checked"></span>
                  <span class="fa fa-star checked"></span>
                  <span class="fa fa-star checked"></span>
                  <span class="fa fa-star"></span>
                </div>
              </div> 
            </div>
          </div>
          <div class="col">
            <div class="card h-100">
              <div class="card-body">
                <div class="row">
                  <div class="row">
                    <p><b>Description</b><br/>
                    <%= listing.description %><br/>
                    <div class="col-8 col-sm-6">
                      <b>Sales or Rent</b><br/>
                      <i class="bi-lightning-charge"></i> <%= listing.sale_or_rent %><br/>
                      <b>Property Type</b><br/>
                      <i class="bi-caret-right"></i> <%= listing.property_type %></p>
                    </div>
                    <div class="col-4 col-sm-6">
                      <p><b>Floor Level</b><br/>
                      <i class="bi-caret-right"></i> <%= listing.floor_level %><br/>
                      <b>Floor Size</b><br/>
                      <i class="bi-caret-right"></i> <%= listing.floor_size %><br/>
                      <b>Rooms</b><br/>
                      <i class="bi-caret-right"></i> <%= listing.rooms %></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card h-100">
              <div class="card-body">
                <p><b>Furnishings</b><br/>
                <%= listing.furnishings %><br/>
                <b>Facilities</b><br/>
                  <% listing.facilities.forEach((facility) => { %>
                    <i class="bi-check"></i>
                    <%= facility.facility_name %> </br>
                <% }) %>
              </p>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card h-100">
              <div class="card-body">
                <p><b>Pricing</b><br/> 
                <i class="bi-currency-dollar"></i> <%= listing.pricing %><br/> 
                <b>Price per psf</b><br/> 
                <i class="bi-currency-dollar"></i> <%= listing.price_psf %><br/>  
                <b>Price Negotiable?</b><br/>
                <i class="bi-question-circle"></i> 
                  <% if(listing.p_negotiable == 1){ %>
                    <%= "yes" %> 
                  <% } else { %>
                    <%= "no" %> 
                  <% } %>
                  <br/>
                <% if(listing.sale_or_rent == "SALE") { %>
                  <b>Tenure</b><br/>
                  <i class="bi-caret-right"></i> <%= listing.tenure %></p>  
                <% } %>
                <% if(listing.sale_or_rent == "RENT") { %>
                <b>Earliest Move In Date</b><br/>
                <i class="bi-clock"></i> <%= listing.availability %><br/>  
                <b>Lease Term</b><br/>
                <i class="bi-caret-right"></i> <%= listing.lease_term %><br/>
                <% } %>
                
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card h-100">
              <div class="card-body">
                <p><b>Address</b><br/>
                <i class="bi-house"></i> <%= listing.listing_address %><br/>
                <b>Postal Code</b><br/>
                <i class="bi-globe"></i> <%= listing.listing_pc %></p>
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d7977.594287696756!2d103.76955672110135!3d1.296345422341832!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31da1a56784202d9%3A0x488d08d6c1f88d6b!2sNational%20University%20of%20Singapore!5e0!3m2!1sen!2ssg!4v1632492901512!5m2!1sen!2ssg" width="400" height="200" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
              </div>
          </div>
        </div>
    </div>
    <% if(listing.sale_or_rent == "SALE") { %>
    <div class="container transactions-group my-5 py-5">
      <h3 style='text-align:center'>Recent <%= listing.rooms %> Room Flat Transactions</h3>
      <div class="row text-center" id="sale-transactions">
      </div>
    </div>
    <% } %>
    <div id="comment">
      <section>
        <div class="container my-5 py-5">
          <div class="rod d-flex justify-content-center" id="new-comment">
            <div class="col-md-12 col-lg-12 col-xl-8">
              <div class="card">
                <div class="card-body">
                  <h3>New Comment</h3>
                  <div class="card-footer py-3 border-0" style="background-color: #f8f9fa;">
                    <form action="/api/comment" method="POST" id="comment-form" onsubmit="return commentSubmitFunction(event)">
                    <div class="d-flex flex-start w-100">
                      <img
                        class="rounded-circle shadow-1-strong me-3"
                        id="user_profile"
                        src="/images/LinkZelda.png"
                        alt="avatar"
                        width="40"
                        height="40"
                      />
                      
                        <div class="form-outline w-100">
                          <textarea
                            class="form-control"
                            id="comments"
                            rows="4"
                            style="background: #fff;"
                            name="comments"
                          ></textarea>
                          <label class="form-label" for="textAreaExample">Message</label>
                        </div>
                        <input type="hidden" name="listing_id" id="listing_id" value="<%= listing.listing_id %>"/>
                      </div>
                      <div class="float-end mt-2 pt-1">
                        <button type="submit" class="btn btn-primary btn-sm">Post comment</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row d-flex justify-content-center">
            <div class="col-md-12 col-lg-10 col-xl-8" id="allComments">
              <div class="card">
                <div class="card-body">
                    <h3>Such emptiness</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    </div>
    

    <!-- javascript -->
    
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fetch-jsonp/1.2.1/fetch-jsonp.js" integrity="sha512-Gys8+rULabLrKdkcher/Qg8hbN6RpNghG0tn1OA3gjlWxE8b5LDSQHEO396eeVlmD9t55pKHslRAKwyWquog9w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="../js/user.js"></script>
    <!-- troll.js must be on top of comment due to comment using some feature available in troll.js -->
    <script src="../js/troll.js"></script> 
    <script src="../js/comment.js"></script>
    <script src="../js/data-gov-api.js"></script>
    
    <script>
      getRecentSaleByRoom("<%= listing.rooms %>")
      getProfilePicture("user_profile")
      document.getElementById('new-comment').style.display = "none"
      const check = checkUserLogin();
      check.then((status) => {
        if(status === false ){
          document.getElementById('new-comment').style.display = "none"
          document.getElementById('new-comment').classList.remove("d-flex")
        }
      })
      const allComments = getAllComments("<%= listing.listing_id %>")
      allComments.then((comments) => {
        document.getElementById('allComments').innerHTML = populateComments(comments)
      })
    </script>
  </body>
</html>